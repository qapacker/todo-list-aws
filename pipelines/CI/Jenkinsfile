pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/qapacker/todo-list-aws.git'
        BRANCH = 'develop'
        STACK_NAME = 'todo-list-aws'
        PATH = "$PATH:/var/lib/jenkins/.local/bin"
    }

    stages {

        stage('Get Code') {
            steps {
                git branch: "${BRANCH}", url: "${REPO_URL}"
            }
        }

        stage('Static Test') {
            steps {
                sh '''
                    echo "üì¶ Instalando herramientas de an√°lisis"
                    pip install --user flake8 bandit

                    mkdir -p reports
                    flake8 src/ --output-file=reports/flake8-report.txt || true
                    bandit -r src/ -f json -o reports/bandit-report.json || true
                '''
                archiveArtifacts artifacts: 'reports/*', allowEmptyArchive: true
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "üöÄ Desplegando a entorno Staging con configuraci√≥n local"
                    pip install --user aws-sam-cli

                    sam build
                    sam deploy \
                    
                        --config-env staging \
                        --config-file samconfig.toml \
                        --no-confirm-changeset \
                        --no-fail-on-empty-changeset
                '''
            }
        }

        stage('Unit Test') {
            steps {
                sh '''
                    echo "üß™ Ejecutando tests unitarios"
                    pip install --user pytest
                    export PATH=$PATH:/var/lib/jenkins/.local/bin

                    mkdir -p reports
                    pytest test/unit/TestToDo.py --junitxml=reports/unit-test-results.xml
                '''
            }
            post {
                always {
                    junit 'reports/unit-test-results.xml'
                }
                failure {
                    error("‚ùå Tests unitarios fallidos.")
                }
            }
        }

        stage('Rest Test') {
            steps {
                sh '''
                    echo "üîó Ejecutando tests REST con URL embebida"
                    pip install --user pytest requests
                    export PATH=$PATH:/var/lib/jenkins/.local/bin

                    mkdir -p reports
                    pytest test/rest-test/test-rest.py --junitxml=reports/rest-api-results.xml
                '''
            }
            post {
                always {
                    junit 'reports/rest-api-results.xml'
                }
                failure {
                    error("‚ùå Tests REST fallidos.")
                }
            }
        }

        stage('Promote') {
            steps {
                sshagent (credentials: ['tu-id-credencial-ssh']) {
                    sh '''
                        echo "üöÄ Creando rama release-candidate"
                        git config --global user.email "info@qapacker.com"
                        git config --global user.name "CI Bot"

                        git checkout -b release-candidate
                        git push origin release-candidate
                    '''
                }
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                        echo "üì® Creando Pull Request autom√°ticamente en GitHub"
                        curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
                            -H "Accept: application/vnd.github.v3+json" \
                            https://api.github.com/repos/qapacker/todo-list-aws/pulls \
                            -d '{
                              "title": "Promoci√≥n de versi√≥n - CI",
                              "head": "release-candidate",
                              "base": "master",
                              "body": "Merge autom√°tico de develop a master para despliegue en producci√≥n"
                            }'
                    '''
                }
            }
        }
    }

    post {
        failure {
            echo "‚ùå Pipeline CI fallido."
        }
        success {
            echo "‚úÖ Pipeline CI finalizado correctamente y PR creado para producci√≥n."
        }
    }
}
